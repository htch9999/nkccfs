<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khoai Chau II High School Confessions</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #a266da;
            --secondary-color: #926ddb;
            --text-color: #333;
            --card-color: #fff;
            --border-color: rgba(138, 43, 226, 0.2);
            --shadow: 0 4px 6px rgba(138, 43, 226, 0.1);
            --hover-shadow: 0 8px 15px rgba(138, 43, 226, 0.2);
            --background-color: #E6E6FA;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        html.dark-mode {
            --primary-color: #b187d9;
            --secondary-color: #a78cdd;
            --text-color: #E6E6FA;
            --card-color: #2d2d2d;
            --border-color: rgba(147, 112, 219, 0.2);
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            --hover-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
            --background-color: #1a1a1a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: var(--transition);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Header Styles */
        header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1.5rem 0;
        }

        h1 {
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .subtitle {
            color: var(--secondary-color);
            font-size: clamp(0.9rem, 3vw, 1.2rem);
            font-weight: 500;
            margin: 1rem 0;
            line-height: 1.5;
        }

        .subtitle a {
            color: rgb(255, 52, 52);
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
        }

        .subtitle a:hover {
            text-decoration: underline;
        }

        /* Theme Toggle */
        .theme-toggle-wrapper {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #3f3f3f;
            transition: var(--transition);
            border-radius: 30px;
        }

        .slider:before {
            position: absolute;
            content: "\f185";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: var(--transition);
            border-radius: 50%;
            color: #3f3f3f;
            font-size: 12px;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(30px);
            content: "\f186";
            color: var(--primary-color);
        }

        /* Header Buttons */
        .header-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.8rem;
            margin: 1.5rem 0;
        }

        .header-btn {
            flex: 1 1 auto;
            min-width: 140px;
            max-width: 200px;
            padding: 0.7rem 1.2rem;
            border: none;
            border-radius: 20px;
            background: var(--card-color);
            color: var(--primary-color);
            font-family: 'Poppins', sans-serif;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .header-btn:before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            opacity: 0;
            transition: var(--transition);
            z-index: -1;
        }

        .header-btn:hover {
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--hover-shadow);
        }

        .header-btn:hover:before {
            opacity: 1;
        }

        .header-btn:active {
            transform: translateY(0);
        }

        /* Confession Counter */
        .confession-counter {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin: 1rem 0;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: var(--transition);
        }

        .confession-counter:hover {
            transform: translateY(-2px);
            box-shadow: var(--hover-shadow);
        }

        .confession-counter:active {
            transform: translateY(0);
        }

        /* Create Post Button */
        .create-post-btn {
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: 500;
            color: white;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 25px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .create-post-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--hover-shadow);
            background: linear-gradient(45deg, var(--secondary-color), var(--primary-color));
        }

        .create-post-btn:active {
            transform: translateY(0);
        }

        /* Form Section */
        .form-section {
            background: var(--card-color);
            padding: 2rem;
            border-radius: 15px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            transition: var(--transition);
            border: 1px solid var(--border-color);
        }

        .form-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .form-header h2 {
            color: var(--primary-color);
            font-size: 1.3rem;
            margin-top: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.2rem;
            position: relative;
        }

        label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-color);
            font-weight: 500;
            font-size: 0.9rem;
        }

        label i {
            color: var(--primary-color);
        }

        input, textarea {
            width: 100%;
            padding: 0.9rem;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-family: inherit;
            font-size: 0.95rem;
            transition: var(--transition);
            background-color: var(--card-color);
            color: var(--text-color);
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(162, 102, 218, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        .submit-btn {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 0.9rem 1.8rem;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: var(--transition);
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .submit-btn:hover {
            background: linear-gradient(45deg, var(--secondary-color), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: var(--hover-shadow);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .submission-notice {
            margin-top: 1rem;
            padding: 0.8rem;
            border-radius: 8px;
            background: rgba(255, 65, 65, 0.1);
            color: var(--text-color);
            font-size: 0.85rem;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            line-height: 1.5;
        }

        /* Confessions Grid */
        .confessions-section {
            margin-top: 2rem;
        }

        .confessions-section h2 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .confession-grid {
            display: grid;
            gap: 1.2rem;
            grid-template-columns: repeat(auto-fill, minmax(min(100%, 300px), 1fr));
        }

        .confession-item {
            background: var(--card-color);
            padding: 1.3rem;
            border-radius: 15px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border-top: 3px solid var(--primary-color);
            position: relative;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            animation: fadeInUp 0.4s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .confession-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--hover-shadow);
        }

        .confession-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .confession-header strong {
            color: var(--primary-color);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.9rem;
        }

        .confession-id {
            font-family: monospace;
            font-size: 0.85rem;
            font-weight: 500;
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            background: rgba(162, 102, 218, 0.15);
        }

        .reply-tag {
            font-family: monospace;
            font-size: 0.85rem;
            font-weight: 500;
            padding: 0.3rem 0.7rem;
            border-radius: 6px;
            background: rgba(162, 102, 218, 0.15);
            margin-bottom: 0.8rem;
            display: inline-block;
        }

        .confession-item p {
            margin-bottom: 1rem;
            color: var(--text-color);
            word-wrap: break-word;
            white-space: pre-wrap;
            flex: 1;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .confession-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 0.8rem;
            border-top: 1px solid var(--border-color);
            margin-top: auto;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .timestamp {
            color: var(--text-color);
            opacity: 0.7;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .button-group {
            display: flex;
            gap: 0.3rem;
            align-items: center;
        }

        .share-btn {
            background: none;
            border: none;
            color: var(--text-color);
            opacity: 0.7;
            font-size: 0.9rem;
            padding: 0.4rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            transition: var(--transition);
            border-radius: 6px;
        }

        .share-btn:hover {
            background: rgba(162, 102, 218, 0.1);
            opacity: 1;
            transform: translateY(-1px);
        }

        .share-btn:active {
            transform: translateY(0);
        }

        .button-separator {
            color: var(--text-color);
            opacity: 0.3;
            margin: 0 0.2rem;
        }

        .comment-count {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        /* Loading Animation */
        .loading {
            text-align: center;
            padding: 3rem;
            grid-column: 1 / -1;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            margin: 0 auto 1rem;
            border: 4px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--primary-color);
            font-size: 1rem;
        }

        .no-confessions {
            text-align: center;
            padding: 3rem;
            background: var(--card-color);
            border-radius: 15px;
            color: var(--text-color);
            grid-column: 1 / -1;
        }

        /* Modal Styles */
        .info-modal, .comment-modal, .create-post-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .info-modal.show, .comment-modal.active, .create-post-modal.active {
            display: flex;
        }

        .info-modal-content, .comment-container, .create-post-content {
            background: var(--card-color);
            padding: 2rem;
            border-radius: 15px;
            box-shadow: var(--shadow);
            max-width: min(800px, 90%);
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .info-modal-content::-webkit-scrollbar,
        .comment-container::-webkit-scrollbar,
        .create-post-content::-webkit-scrollbar {
            width: 8px;
        }

        .info-modal-content::-webkit-scrollbar-track,
        .comment-container::-webkit-scrollbar-track,
        .create-post-content::-webkit-scrollbar-track {
            background: rgba(162, 102, 218, 0.1);
            border-radius: 4px;
        }

        .info-modal-content::-webkit-scrollbar-thumb,
        .comment-container::-webkit-scrollbar-thumb,
        .create-post-content::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        .info-modal-title, .comment-header h3 {
            color: var(--primary-color);
            font-size: 1.4rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .info-modal-body {
            color: var(--text-color);
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .info-modal-body p {
            margin-bottom: 1rem;
        }

        .info-modal-button {
            width: 100%;
            padding: 0.8rem;
            border: none;
            border-radius: 25px;
            background: var(--primary-color);
            color: white;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .info-modal-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--hover-shadow);
        }

        .modal-close, .comment-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 1.5rem;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .modal-close:hover, .comment-close:hover {
            background: rgba(162, 102, 218, 0.1);
            transform: rotate(90deg);
        }

        /* Comment Styles */
        .comment-header {
            padding-bottom: 1rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .comment-list {
            max-height: 50vh;
            overflow-y: auto;
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .comment-item {
            background: rgba(162, 102, 218, 0.1);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .comment-item strong {
            color: var(--primary-color);
            display: block;
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
        }

        .comment-item p {
            margin: 0.5rem 0;
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .comment-form {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .comment-form .input-group {
            display: flex;
            gap: 0.8rem;
        }

        .comment-form input,
        .comment-form textarea {
            padding: 0.8rem;
            border-radius: 8px;
        }

        .comment-form input {
            flex: 1;
        }

        .comment-form textarea {
            min-height: 60px;
            resize: vertical;
        }

        .no-comments {
            text-align: center;
            padding: 2rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        /* Footer */
        footer {
            text-align: center;
            margin-top: 3rem;
            padding: 1.5rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 0.8rem;
            }

            header {
                padding: 1rem 0;
            }

            h1 {
                font-size: 1.5rem;
            }

            .theme-toggle-wrapper {
                top: 10px;
                right: 10px;
            }

            .header-buttons {
                gap: 0.5rem;
            }

            .header-btn {
                min-width: 120px;
                font-size: 0.8rem;
                padding: 0.6rem 1rem;
            }

            .form-section {
                padding: 1.5rem;
            }

            .confession-grid {
                gap: 1rem;
            }

            .confession-item {
                padding: 1rem;
            }

            .info-modal-content,
            .comment-container,
            .create-post-content {
                padding: 1.5rem;
                max-width: 95%;
            }
        }

        @media (max-width: 480px) {
            .header-btn {
                min-width: 100px;
                font-size: 0.75rem;
                padding: 0.5rem 0.8rem;
            }

            .create-post-btn {
                width: 100%;
                justify-content: center;
            }

            .confession-footer {
                flex-direction: column;
                align-items: flex-start;
            }

            .button-group {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="theme-toggle-wrapper">
        <label class="switch">
            <input type="checkbox" id="themeToggle">
            <span class="slider"></span>
        </label>
    </div>

    <div class="container">
        <header>
            <h1>
                <i class="fa-solid fa-graduation-cap"></i>
                Khoai Chau II High School Confessions
            </h1>
            
            <p class="subtitle">
                ⚡🚀 Muốn truy cập vào web nhanh như ăn cướp? Chỉ cần nhớ link rút gọn: 
                <a href="https://bit.ly/nkccfs" target="_blank">bit.ly/nkccfs</a>
            </p>

            <div class="header-buttons">
                <button class="header-btn" id="featuresBtn">
                    <i class="fas fa-book-open"></i>
                    H.dẫn tính năng
                </button>
                <button class="header-btn" id="changelogBtn">
                    <i class="fas fa-history"></i>
                    Nhật ký sửa đổi
                </button>
                <button class="header-btn" id="aboutBtn">
                    <i class="fas fa-info-circle"></i>
                    Về chúng tôi
                </button>
                <button class="header-btn" id="settingsBtn">
                    <i class="fas fa-cog"></i>
                    Cài đặt
                </button>
            </div>

            <div class="confession-counter" id="counterBtn">
                <i class="fas fa-scroll"></i>
                <span id="totalConfessions">0</span> Bài đăng
            </div>

            <button class="create-post-btn" id="createPostBtn">
                <i class="fas fa-plus"></i> Tạo bài đăng mới
            </button>
        </header>
        
        <main>
            <section class="confessions-section" id="confessionsSection">
                <h2><i class="fa-solid fa-share-from-square"></i> Các bài đăng</h2>
                <div id="confessionList" class="confession-grid"></div>
            </section>
        </main>
        
        <footer>
            <p><i class="fa-regular fa-copyright"></i> 2025 - Khoai Chau II Confession. All rights reserved.</p>
        </footer>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" class="info-modal">
        <div class="info-modal-content">
            <h3 class="info-modal-title"></h3>
            <div class="info-modal-body"></div>
            <button class="info-modal-button">Đóng</button>
        </div>
    </div>

    <!-- Comment Modal -->
    <div class="comment-modal" id="commentModal">
        <div class="comment-container">
            <button class="comment-close" id="commentClose">
                <i class="fas fa-times"></i>
            </button>
            <div class="comment-header">
                <h3><i class="fas fa-comments"></i> <span class="comment-title"></span></h3>
            </div>
            <div class="comment-list"></div>
            <form class="comment-form" id="commentForm">
                <input type="hidden" id="confessionId">
                <div class="input-group">
                    <input type="text" id="commentName" placeholder="Tên của bạn (không bắt buộc)" maxlength="50">
                    <button type="submit" class="submit-btn" style="width: auto; padding: 0.8rem 1.2rem;">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <textarea id="commentContent" placeholder="Viết bình luận của bạn..." required maxlength="500"></textarea>
            </form>
        </div>
    </div>

    <!-- Create Post Modal -->
    <div id="createPostModal" class="create-post-modal">
        <div class="create-post-content">
            <button class="modal-close" id="closePostModal">
                <i class="fas fa-times"></i>
            </button>
            <section class="form-section">
                <div class="form-header">
                    <i class="fa-solid fa-pen-to-square"></i>
                    <h2>Tạo một bài đăng mới</h2>
                </div>
                <form id="confessionForm">
                    <div class="form-group">
                        <label for="name"><i class="fas fa-user-secret"></i> Tên của bạn (tuỳ chọn)</label>
                        <input type="text" id="name" name="name" placeholder="Ẩn danh" maxlength="50">
                    </div>
                    
                    <div class="form-group">
                        <label for="confession"><i class="fas fa-heart"></i> Nội dung</label>
                        <textarea id="confession" name="confession" rows="6" 
                            placeholder="Nội dung bài đăng của bạn..." required maxlength="1000"></textarea>
                    </div>
                    
                    <button type="submit" class="submit-btn">
                        <i class="fas fa-paper-plane"></i> Đăng!
                    </button>
                    <p class="submission-notice">
                        <i class="fas fa-exclamation-circle"></i>
                        Vui lòng đăng bài với thái độ tôn trọng. Không sử dụng từ ngữ phân biệt, miệt thị hoặc thô tục.
                    </p>
                </form>
            </section>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Configuration
        const API_URL = 'https://script.google.com/macros/s/AKfycbxZidtEOqL7ky8vG7YgMS_sNiuIUzLPEidORf7OJ7E7FjbD4fF47JyucF4fVJCxA5mM/exec';
        const CACHE_DURATION = 30000; // 30 seconds
        let confessionsCache = null;
        let lastFetchTime = 0;

        // Toast Helper
        function showToast(icon, title, timer = 2000) {
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: timer,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer);
                    toast.addEventListener('mouseleave', Swal.resumeTimer);
                }
            });
            return Toast.fire({ icon, title });
        }

        // Theme Toggle
        const themeToggle = document.getElementById('themeToggle');
        const htmlElement = document.documentElement;

        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                htmlElement.classList.add('dark-mode');
                themeToggle.checked = true;
            }
        }

        themeToggle.addEventListener('change', () => {
            if (themeToggle.checked) {
                htmlElement.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
            } else {
                htmlElement.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
            }
        });

        // Counter Animation
        function animateCounter(element, targetValue) {
            const duration = 1000;
            const steps = 30;
            const stepDuration = duration / steps;
            const increment = targetValue / steps;
            let current = 0;
            
            const timer = setInterval(() => {
                current += increment;
                if (current >= targetValue) {
                    clearInterval(timer);
                    element.textContent = targetValue;
                } else {
                    element.textContent = Math.floor(current);
                }
            }, stepDuration);
        }

        // Fetch with Cache
        async function fetchConfessions() {
            const now = Date.now();
            
            if (confessionsCache && (now - lastFetchTime) < CACHE_DURATION) {
                return confessionsCache;
            }

            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                confessionsCache = data;
                lastFetchTime = now;
                return data;
            } catch (error) {
                console.error('Fetch error:', error);
                throw error;
            }
        }

        // Display Confessions
        async function displayConfessions() {
            const confessionList = document.getElementById('confessionList');
            confessionList.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p class="loading-text">Đang tải bài đăng...</p>
                </div>
            `;

            try {
                const data = await fetchConfessions();
                const confessions = data.confessions || [];
                
                confessionList.innerHTML = '';
                
                if (confessions.length === 0) {
                    confessionList.innerHTML = `
                        <div class="no-confessions">
                            <i class="fas fa-comment-slash" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                            <p>Chưa có bài đăng nào. Hãy trở thành người đầu tiên chia sẻ!</p>
                        </div>
                    `;
                    return;
                }

                // Update counter with animation
                const totalConfessionsElement = document.getElementById('totalConfessions');
                animateCounter(totalConfessionsElement, confessions.length);
                
                // Create confession items with staggered animation
                confessions.forEach((confession, index) => {
                    setTimeout(() => {
                        const item = createConfessionItem(confession, data.comments);
                        confessionList.appendChild(item);
                    }, index * 50); // Stagger by 50ms
                });

            } catch (error) {
                confessionList.innerHTML = `
                    <div class="no-confessions">
                        <i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                        <p>Tải bài đăng thất bại. Hãy thử lại sau.</p>
                    </div>
                `;
            }
        }

        // Create Confession Item
        function createConfessionItem(confession, allComments) {
            const confessionItem = document.createElement('div');
            confessionItem.className = 'confession-item';
            confessionItem.dataset.id = confession.id;
            
            const name = confession.name?.trim() || 'Người dùng ẩn danh';
            const confessionId = confession.id || '#nkccfsbeta';
            const confessionText = confession.confession || '';
            const timestamp = confession.timestamp;
            
            const replyMatch = confessionText.match(/<reply_(#nkccfs\d{3})>(.*)/s);
            let displayText = confessionText;
            let replyTag = '';
            
            if (replyMatch) {
                const [, replyId, content] = replyMatch;
                replyTag = `<div class="reply-tag">Trả lời ${replyId}</div>`;
                displayText = content.trim();
            }
            
            const commentCount = (allComments || []).filter(c => c.confessionId === confessionId).length;
            
            confessionItem.innerHTML = `
                <div class="confession-header">
                    <strong><i class="fas fa-user"></i> ${escapeHtml(name)}</strong>
                    <span class="confession-id">${confessionId}</span>
                </div>
                ${replyTag}
                <p>${escapeHtml(displayText).replace(/\n/g, '<br>')}</p>
                <div class="confession-footer">
                    <small class="timestamp">
                        <i class="fas fa-clock"></i> 
                        ${formatDate(timestamp)}
                    </small>
                    <div class="button-group">
                        <button class="share-btn" title="Chia sẻ liên kết" onclick="shareConfession('${confessionId}')">
                            <i class="fas fa-share-alt"></i>
                        </button>
                        <button class="share-btn" title="Trả lời bài đăng" onclick="replyToConfession('${confessionId}')">
                            <i class="fas fa-reply"></i>
                        </button>
                        <span class="button-separator">|</span>
                        <button class="share-btn" title="Bình luận" onclick="openComments('${confessionId}', '${escapeHtml(name)}')">
                            <i class="fas fa-comments"></i>
                            <span class="comment-count">${commentCount}</span>
                        </button>
                    </div>
                </div>
            `;
            
            return confessionItem;
        }

        // Helper Functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            
            if (hours < 1) {
                const minutes = Math.floor(diff / (1000 * 60));
                return minutes < 1 ? 'Vừa xong' : `${minutes} phút trước`;
            } else if (hours < 24) {
                return `${hours} giờ trước`;
            } else {
                return date.toLocaleDateString('vi-VN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        }

        // Share Confession
        async function shareConfession(confessionId) {
            const url = `${window.location.origin}${window.location.pathname}?confession=${confessionId}`;
            
            try {
                if (navigator.share) {
                    await navigator.share({
                        title: 'KCII Confession',
                        text: `Xem bài đăng ${confessionId}`,
                        url: url
                    });
                } else {
                    await navigator.clipboard.writeText(url);
                    showToast('success', 'Đã sao chép liên kết!');
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Share error:', error);
                }
            }
        }

        // Reply to Confession
        function replyToConfession(confessionId) {
            document.getElementById('createPostModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            
            const textarea = document.getElementById('confession');
            textarea.value = `<reply_${confessionId}>`;
            textarea.focus();
            
            setTimeout(() => {
                textarea.setSelectionRange(textarea.value.length, textarea.value.length);
            }, 100);
        }

        // Comments
        async function openComments(confessionId, userName) {
            const modal = document.getElementById('commentModal');
            const commentList = modal.querySelector('.comment-list');
            
            modal.querySelector('.comment-title').textContent = `Bài viết của ${userName}`;
            document.getElementById('confessionId').value = confessionId;
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            await loadComments(confessionId);
        }

        async function loadComments(confessionId) {
            const commentList = document.querySelector('.comment-list');
            commentList.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p class="loading-text">Đang tải...</p></div>';
            
            try {
                const data = await fetchConfessions();
                const comments = (data.comments || [])
                    .filter(c => c.confessionId === confessionId)
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                if (comments.length === 0) {
                    commentList.innerHTML = '<p class="no-comments">Chưa có bình luận nào.</p>';
                    return;
                }
                
                commentList.innerHTML = comments.map(comment => `
                    <div class="comment-item">
                        <strong><i class="fas fa-user"></i> ${escapeHtml(comment.name || 'Ẩn danh')}</strong>
                        <p>${escapeHtml(comment.comment)}</p>
                        <small class="timestamp">
                            <i class="fas fa-clock"></i> ${formatDate(comment.timestamp)}
                        </small>
                    </div>
                `).join('');
                
            } catch (error) {
                commentList.innerHTML = '<p class="no-comments">Không thể tải bình luận.</p>';
            }
        }

        // Form Submissions
        document.getElementById('confessionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const form = e.target;
            const submitBtn = form.querySelector('.submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang đăng...';
            
            try {
                const formData = new FormData(form);
                const data = {
                    name: formData.get('name') || 'Ẩn danh',
                    confession: formData.get('confession'),
                    timestamp: new Date().toISOString()
                };
                
                await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                form.reset();
                document.getElementById('createPostModal').classList.remove('active');
                document.body.style.overflow = '';
                
                showToast('success', 'Đã đăng bài thành công!');
                
                // Clear cache and reload
                confessionsCache = null;
                setTimeout(() => displayConfessions(), 1000);
                
            } catch (error) {
                showToast('error', 'Đăng bài thất bại. Vui lòng thử lại.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Đăng!';
            }
        });

        document.getElementById('commentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            
            if (form.classList.contains('submitting')) return;
            form.classList.add('submitting');
            submitBtn.disabled = true;
            
            try {
                const confessionId = document.getElementById('confessionId').value;
                const data = {
                    type: 'comment',
                    confessionId: confessionId,
                    name: document.getElementById('commentName').value.trim() || 'Ẩn danh',
                    comment: document.getElementById('commentContent').value.trim(),
                    timestamp: new Date().toISOString()
                };
                
                await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                document.getElementById('commentContent').value = '';
                showToast('success', 'Đã đăng bình luận!');
                
                // Clear cache and reload comments
                confessionsCache = null;
                setTimeout(() => loadComments(confessionId), 1000);
                
            } catch (error) {
                showToast('error', 'Không thể đăng bình luận.');
            } finally {
                form.classList.remove('submitting');
                submitBtn.disabled = false;
            }
        });

        // Modal Controls
        document.getElementById('createPostBtn').addEventListener('click', () => {
            document.getElementById('createPostModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        });

        document.getElementById('closePostModal').addEventListener('click', () => {
            document.getElementById('createPostModal').classList.remove('active');
            document.body.style.overflow = '';
        });

        document.getElementById('commentClose').addEventListener('click', () => {
            document.getElementById('commentModal').classList.remove('active');
            document.body.style.overflow = '';
        });

        document.getElementById('counterBtn').addEventListener('click', () => {
            document.getElementById('confessionsSection').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        });

        // Close modals on outside click
        [document.getElementById('createPostModal'), document.getElementById('commentModal'), document.getElementById('infoModal')].forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                    modal.classList.remove('show');
                    document.body.style.overflow = '';
                }
            });
        });

        // Info Modals
        function showInfoModal(title, content) {
            const modal = document.getElementById('infoModal');
            modal.querySelector('.info-modal-title').textContent = title;
            modal.querySelector('.info-modal-body').innerHTML = content;
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        document.getElementById('featuresBtn').addEventListener('click', () => {
            showInfoModal('Hướng dẫn tính năng', `
                <p><i class="fas fa-reply"></i> <strong>Trả lời bài đăng:</strong> Nhấn nút reply để trả lời một bài đăng cụ thể</p>
                <p><i class="fas fa-share-alt"></i> <strong>Chia sẻ:</strong> Chia sẻ bài đăng qua đường link</p>
                <p><i class="fas fa-comments"></i> <strong>Bình luận:</strong> Xem và bình luận bài đăng</p>
                <p><i class="fas fa-moon"></i> <strong>Chế độ tối:</strong> Chuyển đổi giao diện sáng/tối</p>
            `);
        });

        document.getElementById('changelogBtn').addEventListener('click', () => {
            showInfoModal('Nhật ký sửa đổi', `
                <p style="text-align: center;"><strong>Bản cập nhật mới nhất</strong></p>
                <ul>
                    <li><i class="fas fa-bolt"></i> Tối ưu hóa hiệu suất tải trang</li>
                    <li><i class="fas fa-paint-brush"></i> Cải thiện UI/UX toàn diện</li>
                    <li><i class="fas fa-mobile-alt"></i> Responsive design tốt hơn</li>
                    <li><i class="fas fa-clock"></i> Hiển thị thời gian tương đối</li>
                    <li><i class="fas fa-database"></i> Thêm caching để giảm tải server</li>
                </ul>
            `);
        });

        document.getElementById('aboutBtn').addEventListener('click', () => {
            showInfoModal('Về chúng tôi', `
                <p><strong>KCII Confessions</strong> là dự án phi lợi nhuận được tạo ra với mục đích xây dựng một cộng đồng kết nối những người đã, đang và sẽ là học sinh của trường THPT Khoái Châu II.</p>
                <p><strong>Sứ mệnh:</strong> Tạo ra một không gian an toàn và tích cực để các bạn học sinh có thể chia sẻ, kết nối và xây dựng cộng đồng.</p>
                <p><strong>Liên hệ:</strong></p>
                <ul style="list-style: none; padding: 0;">
                    <li><i class="fas fa-envelope"></i> azamiyuuki008@gmail.com</li>
                    <li><i class="fab fa-facebook"></i> fb.com/htch.9999</li>
                </ul>
            `);
        });

        document.getElementById('settingsBtn').addEventListener('click', () => {
            showInfoModal('Cài đặt', `
                <div style="padding: 1rem; background: rgba(162, 102, 218, 0.1); border-radius: 10px;">
                    <p><strong>Chế độ tối</strong></p>
                    <p>Sử dụng nút chuyển đổi ở góc trên bên phải để bật/tắt chế độ tối.</p>
                </div>
            `);
        });

        document.querySelector('.info-modal-button').addEventListener('click', () => {
            document.getElementById('infoModal').classList.remove('show');
            document.body.style.overflow = '';
        });

        // Initialize
        initTheme();
        displayConfessions();

        // Auto refresh every 5 minutes
        setInterval(() => {
            confessionsCache = null;
            displayConfessions();
        }, 300000);
    </script>
</body>
</html>
